# Stage 4 知识点与用例意义

本文档归纳 Stage 4（Agent Core）的核心知识点，以及 `examples/basic-usage.ts` 的用意与可借鉴之处。

---

## 一、Stage 4 在讲什么（知识点）

Stage 4 解决的是：**「以目标（goal）为入口、多步执行、中间状态与失败恢复、Memory 写回」**。在 Stage 3 工具循环之上做一层 Agent 编排。

### 1. 任务入口：Goal

Agent 的输入是 **goal**（用户目标），而不是单条 user 消息。`runAgent(deps, sessionId, goal, options)` 内部将 goal 作为 user 消息交给 Stage 3 的 `runToolLoop`，由工具循环完成「是否调工具、调几次、何时结束」。

### 2. 多步执行

沿用 Stage 3 的 **runToolLoop**：LLM 决策 → 解析 → 执行工具 → 回注 → 再调用 LLM，直到模型返回最终回复或达到 `maxToolRounds`。当前实现是 **reactive** 模式：不先让 LLM 输出「步骤列表」，而是每轮由模型决定下一步；若需 Plan-and-Execute，可在本层扩展「先规划再按步执行」。

### 3. 中间状态与失败恢复

每次 run 生成 **runId**，将运行状态写入可选的 **AgentStateStore**：

- **AgentRunState**：runId、sessionId、goal、status（running / completed / failed）、startedAt、finishedAt、toolRounds、reply、lastRawContent、error 等。
- **AgentStateStore**：`get(runId)`、`set(state)`、`delete(runId)`、`listBySession(sessionId)`。

便于审计、按 session 查历史 run，以及后续扩展「从某 runId/step 恢复」。默认提供内存实现 **createAgentStateStore()**。

### 4. Memory 写回

可选在 run 结束后，将本次执行的简短摘要写入 Context Engine 的 **setSummary(sessionId, summary)**，供后续对话使用。示例中 `writeSummaryToMemory: true` 会写入「Last agent run: goal=...; reply=...; tool rounds=...」。

### 5. runAgent 与依赖

**runAgent(deps, sessionId, goal, options)**：

- **deps**：Stage 0 chat、Stage 1 contextEngine、Stage 2 outputController、Stage 3 toolRegistry，以及可选的 stateStore。
- 生成 runId，可选将「running」状态写入 stateStore。
- 调用 **runToolLoop(toolLoopDeps, sessionId, goal, ...)** 完成多步执行。
- 结束后将「completed」或「failed」状态写入 stateStore；若 options.writeSummaryToMemory 为 true，则 setSummary。
- 返回 **AgentRunResult**（success、runId、reply、toolRounds、state 等）。

---

## 二、basic-usage.ts 在演示什么

- 组装 Stage 0 / 1 / 2 / 3（Gateway、Context Engine、Output Controller、Tool Registry）。
- 创建 **createAgentStateStore()** 并传入 deps，使每次 run 被持久化。
- 调用 **runAgent(deps, sessionId, goal, { writeSummaryToMemory: true })**，goal 为「上海天气」。
- 打印 Run id、Success、Reply、Tool rounds、Runs in session、Memory summary，验证状态存储与 Memory 写回。

---

## 三、与其它 Stage 的关系

- **Stage 0**：提供 chat，Agent 不直接调 HTTP。
- **Stage 1**：提供 session 与 getMessagesForRequest / addMessage / setSummary；Agent 写回 summary 即写回 Memory。
- **Stage 2**：提供 parseAndValidate，用于解析工具决策 JSON。
- **Stage 3**：提供 runToolLoop 与 ToolRegistry；Agent 只编排「一次 goal → 一次 runToolLoop → 状态与 Memory 写回」。

Stage 4 是「任务编排 + 状态 + Memory」层，为 Stage 5（多 Agent、Human-in-the-loop、权限与审计）打基础。
