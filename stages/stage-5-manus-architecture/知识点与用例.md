# Stage 5 知识点与用例

## 知识点

1. **多 Agent 协作**  
   本阶段用「多步工作流」表达：每步一个 goal、一次 runAgent，步骤顺序执行，同一 session 内上下文累积。可理解为多个逻辑 Agent 按流水线协作（先调研 Agent，再总结 Agent）。

2. **人类介入（Human-in-the-loop）**  
   通过 `HumanApprovalProvider` 在关键节点暂停并请求人工决定（如是否继续下一步）。示例提供控制台输入（y/n）与自动通过两种实现；生产可接审批系统或 UI。

3. **权限**  
   `PermissionChecker` 基于「actor → role → actions」：先查 actor 的角色，再查该角色允许的动作。默认角色 user / admin 与动作（run_workflow、view_audit 等）可扩展。

4. **成本**  
   `CostTracker` 通过包装 `chat` 在每次调用后记录 `ChatResult.cost`，按 session 与全局聚合。Gateway 需在 ChatResult 中返回 cost（Stage 0 已支持）。

5. **审计日志**  
   `AuditLogStore` 仅追加，记录 workflow/step/approval 等事件，支持按 session、runId、workflowId 查询，便于合规与排障。

## 用例

- **用例 1**：多步流水线（先查天气再查时间），无人类批准，看审计与成本。
- **用例 2**：同上，开启 `approveBetweenSteps`，使用控制台批准，第二步前输入 n 可中止。
- **用例 3**：配置 permissionCheck，非 admin 禁止 run_workflow，验证权限拒绝。
- **用例 4**：同一 session 跑多个 workflow，用 getSessionCost / listBySession 看总成本与审计。
